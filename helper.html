<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sidebrain Helper</title>
  <style>
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#0b0b0f; color:#eaeaf2; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 18px; }
    h1 { font-size: 18px; margin: 0 0 10px; }
    .muted { opacity: .75; font-size: 13px; }
    .card { background: rgba(255,255,255,.05); border: 1px solid rgba(255,255,255,.10); border-radius: 16px; padding: 14px; margin: 12px 0; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    label { font-size: 12px; opacity: .8; display:block; margin-bottom: 6px; }
    input, textarea, select, button {
      border-radius: 12px; border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.25); color: #eaeaf2;
      padding: 10px 12px; font-size: 14px;
    }
    input, select { height: 40px; }
    textarea { width: 100%; min-height: 84px; resize: vertical; }
    .grow { flex: 1; min-width: 260px; }
    button { cursor: pointer; }
    button.primary { background: rgba(125,211,252,.20); border-color: rgba(125,211,252,.35); }
    button.ghost { background: transparent; }
    code, pre { background: rgba(0,0,0,.35); border: 1px solid rgba(255,255,255,.10); border-radius: 12px; padding: 10px 12px; display:block; overflow:auto; }
    .ok { color: #9ef0c2; }
    .warn { color: #ffd08a; }
    .err { color: #ff9aa9; }
    .mini { font-size: 12px; opacity: .85; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 860px){ .grid2{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üß† Sidebrain Helper</h1>
    <div class="muted">
      This helper generates correctly formatted rows for your Sidebrain CSV sheet and builds share links.
      It does <b>not</b> write into Google Sheets automatically (copy/paste workflow).
    </div>

    <div class="card">
      <div class="row">
        <div class="grow">
          <label>Spreadsheet / CSV URL (can be ‚ÄúPublish to web‚Äù CSV, or a normal Google Sheet URL)</label>
          <input id="sheetUrl" class="grow" placeholder="Paste Google Sheets URL or CSV URL‚Ä¶" />
          <div class="mini muted">You can also pass it via URL: <code>?sheet=ENCODED_URL</code></div>
        </div>

        <div style="min-width:190px">
          <label>Database name (optional)</label>
          <input id="dbName" placeholder="ART / PPL / ‚Ä¶" />
        </div>

        <div style="display:flex; gap:10px; align-items:flex-end">
          <button id="btnApply" class="primary">Apply</button>
          <button id="btnCopyHelperLink" class="ghost">Copy helper link</button>
        </div>
      </div>

      <div id="status" class="mini muted" style="margin-top:10px"></div>
    </div>

    <div class="card">
      <div class="grid2">
        <div>
          <label>Flash9 app link (encoded)</label>
          <pre id="appLink"></pre>
          <button id="btnCopyAppLink" class="ghost">Copy app link</button>
        </div>
        <div>
          <label>Detected CSV URL</label>
          <pre id="csvUrlOut"></pre>
          <button id="btnCopyCsv" class="ghost">Copy CSV URL</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h2 style="font-size:15px;margin:0 0 10px">Add entry (copy/paste into Google Sheets)</h2>

      <div class="grid2">
        <div>
          <label>NAME</label>
          <input id="name" class="grow" placeholder="e.g., Ingrid Oberkanins" />
        </div>
        <div>
          <label>GROUPS (space-separated; use : for hierarchy)</label>
          <input id="groups" class="grow" placeholder="music:instr:piano uni:univie:wisskomm" />
        </div>
      </div>

      <div class="grid2" style="margin-top:10px">
        <div>
          <label>IMAGE URL or [TEXT]</label>
          <input id="image" class="grow" placeholder="https://...jpg  OR  [Piano]" />
          <div class="mini muted">If you wrap text in brackets <code>[like this]</code>, Sidebrain shows it as a text-card face.</div>
        </div>
        <div>
          <label>INFO (supports Markdown links)</label>
          <input id="info" class="grow" placeholder="violin [piece](https://open.spotify.com/track/...)" />
        </div>
      </div>

      <div style="margin-top:12px">
        <button id="btnMakeRow" class="primary">Generate row</button>
        <button id="btnClear" class="ghost">Clear</button>
      </div>

      <div style="margin-top:12px">
        <label>Row output (TAB-separated; paste as a new row in Google Sheets)</label>
        <pre id="rowOut"></pre>
        <button id="btnCopyRow" class="ghost">Copy row</button>
      </div>

      <div class="mini muted" style="margin-top:8px">
        Tip: In Google Sheets, click the first empty cell of a new row, then paste.
      </div>
    </div>
  </div>

<script>
  const el = (id) => document.getElementById(id);

  function qp(name) {
    const u = new URL(location.href);
    return u.searchParams.get(name);
  }

  function setStatus(msg, cls="muted") {
    const s = el("status");
    s.className = "mini " + cls;
    s.textContent = msg || "";
  }

  function copyText(txt) {
    return navigator.clipboard.writeText(txt);
  }

  // Try to turn a normal Google Sheets URL into a "publish CSV" URL if possible.
  // If the user already provides output=csv, we keep it.
  function normalizeToCsvUrl(input) {
    const raw = (input || "").trim();
    if (!raw) return "";

    // Already a publish-to-web CSV URL
    if (raw.includes("output=csv")) return raw;

    // If it's a normal "docs.google.com/spreadsheets/d/<id>/..." URL,
    // we cannot magically publish it without user publishing.
    // But we can at least keep it for reference.
    return raw;
  }

  function makeAppLink(csvUrl, dbName) {
    const appBase = location.href.replace(/helper\.html.*/i, "index.html");
    const u = new URL(appBase);
    if (dbName) u.searchParams.set("database", dbName);
    if (csvUrl) u.searchParams.set("csv", csvUrl); // URLSearchParams will encode it
    return u.toString();
  }

  function makeHelperLink(sheetUrl, dbName) {
    const u = new URL(location.href);
    if (sheetUrl) u.searchParams.set("sheet", sheetUrl); // URLSearchParams will encode it
    if (dbName) u.searchParams.set("database", dbName);
    return u.toString();
  }

  function tsvEscapeCell(s) {
    // Keep it simple: replace tabs/newlines so paste is safe
    return String(s || "").replace(/\t/g, " ").replace(/\r?\n/g, " ").trim();
  }

  function generateRow() {
    const name = tsvEscapeCell(el("name").value);
    const groups = tsvEscapeCell(el("groups").value);
    const image = tsvEscapeCell(el("image").value);
    const info = tsvEscapeCell(el("info").value);

    if (!name) {
      setStatus("NAME is required.", "err");
      return "";
    }
    // 4-column format: NAME, GROUPS, IMAGE-URL/TEXT, INFO
    return [name, groups, image, info].join("\t");
  }

  function apply() {
    const sheetUrl = el("sheetUrl").value.trim();
    const dbName = el("dbName").value.trim();

    const csvUrl = normalizeToCsvUrl(sheetUrl);

    el("csvUrlOut").textContent = csvUrl || "(none)";
    el("appLink").textContent = csvUrl ? makeAppLink(csvUrl, dbName) : "(paste a sheet/csv URL above)";
    setStatus("Ready.", "ok");
  }

  // init from URL params
  (function init() {
    const sheet = qp("sheet");
    const db = qp("database") || qp("databse") || ""; // tolerate typo

    if (sheet) el("sheetUrl").value = sheet;
    if (db) el("dbName").value = db;

    apply();
  })();

  el("btnApply").addEventListener("click", apply);

  el("btnCopyHelperLink").addEventListener("click", async () => {
    const sheetUrl = el("sheetUrl").value.trim();
    const dbName = el("dbName").value.trim();
    const link = makeHelperLink(sheetUrl, dbName);
    try {
      await copyText(link);
      setStatus("Helper link copied.", "ok");
    } catch {
      setStatus("Could not copy helper link (clipboard blocked).", "warn");
    }
  });

  el("btnCopyAppLink").addEventListener("click", async () => {
    const txt = el("appLink").textContent.trim();
    if (!txt || txt.startsWith("(")) return;
    try {
      await copyText(txt);
      setStatus("App link copied.", "ok");
    } catch {
      setStatus("Could not copy app link (clipboard blocked).", "warn");
    }
  });

  el("btnCopyCsv").addEventListener("click", async () => {
    const txt = el("csvUrlOut").textContent.trim();
    if (!txt || txt.startsWith("(")) return;
    try {
      await copyText(txt);
      setStatus("CSV URL copied.", "ok");
    } catch {
      setStatus("Could not copy CSV URL (clipboard blocked).", "warn");
    }
  });

  el("btnMakeRow").addEventListener("click", () => {
    const row = generateRow();
    if (!row) return;
    el("rowOut").textContent = row;
    setStatus("Row generated. Copy and paste it into Google Sheets.", "ok");
  });

  el("btnCopyRow").addEventListener("click", async () => {
    const txt = el("rowOut").textContent;
    if (!txt) return;
    try {
      await copyText(txt);
      setStatus("Row copied (TSV). Paste into a new row in Google Sheets.", "ok");
    } catch {
      setStatus("Could not copy row (clipboard blocked).", "warn");
    }
  });

  el("btnClear").addEventListener("click", () => {
    el("name").value = "";
    el("groups").value = "";
    el("image").value = "";
    el("info").value = "";
    el("rowOut").textContent = "";
    setStatus("Cleared.", "ok");
  });
</script>
</body>
</html>
